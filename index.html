      
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>寒促头像合成工具</title>
    <!-- 引入 Tailwind CSS 用于样式 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 和 ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- 引入 Babel 用于在浏览器中解析 JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* 自定义滚动条样式 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #e5e7eb;
            border-radius: 20px;
        }
        body {
            font-family: "Microsoft YaHei", sans-serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 图标组件 ---
        const Download = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        );
        const Type = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
        );
        const ImageIcon = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
        );
        const Loader2 = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={`animate-spin ${className}`}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );
        const AlertCircle = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        );
        const Lock = ({ size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        );

        // --- 主程序 ---
        const AvatarGenerator = () => {
            // Canvas settings
            const CANVAS_SIZE = 1500;
            
            // 固定样式参数 (Corporate Standards)
            const FIXED_FONT_SIZE = 420;
            const FIXED_STROKE_WIDTH = 18;
            const FIXED_STROKE_COLOR = '#0172f1';
            const FIXED_FILL_COLOR = '#ffffff';

            // State
            const [text, setText] = useState('寒促');
            
            // Font State
            const [fontFamily, setFontFamily] = useState('"Microsoft YaHei", sans-serif');
            const [isFontLoading, setIsFontLoading] = useState(true);
            const [fontLoadError, setFontLoadError] = useState(false);
            
            // Image State
            const [bgImage, setBgImage] = useState(null);
            const [isImageLoading, setIsImageLoading] = useState(true);

            const canvasRef = useRef(null);

            // 1. 加载网络字体
            useEffect(() => {
                const loadFont = async () => {
                    try {
                        setIsFontLoading(true);
                        // 使用 jsDelivr 加载优设标题黑
                        const fontUrl = 'https://cdn.jsdelivr.net/gh/callmeyyzx/FontsForWeb@master/YouSheBiaoTiHei.ttf';
                        const fontFace = new FontFace('YouSheBiaoTiHei', `url(${fontUrl})`);
                        
                        const loadedFace = await fontFace.load();
                        document.fonts.add(loadedFace);
                        setFontFamily('"YouSheBiaoTiHei"'); 
                        setIsFontLoading(false);
                        setFontLoadError(false);
                    } catch (err) {
                        console.error('Font loading failed:', err);
                        setIsFontLoading(false);
                        setFontLoadError(true);
                        // 失败则回退到系统加粗字体
                        setFontFamily('"Microsoft YaHei", "SimHei", sans-serif');
                    }
                };

                if (typeof FontFace !== 'undefined') {
                    loadFont();
                } else {
                    setIsFontLoading(false);
                    setFontLoadError(true);
                }
            }, []);

            // 2. 加载默认底图 (固定)
            useEffect(() => {
                const defaultImgUrl = 'https://www.helloimg.com/i/2026/01/09/6960c24f656f2.jpg';
                
                setIsImageLoading(true);
                const img = new Image();
                img.crossOrigin = "Anonymous"; // 允许跨域，以便导出图片
                img.src = defaultImgUrl;
                
                img.onload = () => {
                    setBgImage(img);
                    setIsImageLoading(false);
                };
                
                img.onerror = (e) => {
                    console.error("Failed to load default background image", e);
                    setIsImageLoading(false);
                };
            }, []);

            // 3. 绘制 Canvas
            useEffect(() => {
                drawCanvas();
            }, [text, fontFamily, bgImage, fontLoadError]);

            const drawCanvas = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');

                // 清除画布
                ctx.clearRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);

                // 绘制背景
                if (bgImage) {
                    const aspect = bgImage.width / bgImage.height;
                    let drawWidth = CANVAS_SIZE;
                    let drawHeight = CANVAS_SIZE;
                    let offsetX = 0;
                    let offsetY = 0;

                    if (aspect > 1) {
                        drawHeight = CANVAS_SIZE;
                        drawWidth = CANVAS_SIZE * aspect;
                        offsetX = -(drawWidth - CANVAS_SIZE) / 2;
                    } else {
                        drawWidth = CANVAS_SIZE;
                        drawHeight = CANVAS_SIZE / aspect;
                        offsetY = -(drawHeight - CANVAS_SIZE) / 2;
                    }
                    
                    ctx.drawImage(bgImage, offsetX, offsetY, drawWidth, drawHeight);
                } else {
                    ctx.fillStyle = '#f3f4f6';
                    ctx.fillRect(0, 0, CANVAS_SIZE, CANVAS_SIZE);
                    // 背景未加载时不绘制文字提示，由 Overlay 接管
                }

                // 绘制文字
                if (text) {
                    const centerX = CANVAS_SIZE / 2;
                    const centerY = CANVAS_SIZE / 2;

                    ctx.save();
                    ctx.translate(centerX, centerY);
                    
                    // 如果字体加载失败，使用加粗的备选字体
                    const fontWeight = fontLoadError ? '900' : 'normal';
                    ctx.font = `${fontWeight} ${FIXED_FONT_SIZE}px ${fontFamily}`;
                    
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.lineJoin = 'round';
                    ctx.miterLimit = 2;

                    // 外描边（先画两倍宽度的描边）
                    ctx.lineWidth = FIXED_STROKE_WIDTH * 2;
                    ctx.strokeStyle = FIXED_STROKE_COLOR;
                    ctx.strokeText(text, 0, 0);

                    // 内填充
                    ctx.fillStyle = FIXED_FILL_COLOR;
                    ctx.fillText(text, 0, 0);

                    ctx.restore();
                }
            };

            const handleDownload = () => {
                try {
                    const canvas = canvasRef.current;
                    const link = document.createElement('a');
                    link.download = `寒促头像-${text}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                } catch (e) {
                    alert("图片下载失败，请检查网络连接。");
                }
            };

            // 判断是否处于加载状态
            const isLoading = isFontLoading || isImageLoading;

            return (
                <div className="flex flex-col h-screen bg-gray-50 text-gray-800">
                    {/* Header */}
                    <header className="bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between shadow-sm z-10">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-2 rounded-lg text-white">
                                <ImageIcon size={24} />
                            </div>
                            <h1 className="text-xl font-bold tracking-tight text-gray-900">寒促头像合成工具</h1>
                        </div>
                        <button 
                            onClick={handleDownload}
                            className={`flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg transition-colors font-medium shadow-sm active:transform active:scale-95 ${isLoading ? 'opacity-50 cursor-not-allowed' : ''}`}
                            disabled={isLoading}
                        >
                            <Download size={18} />
                            下载图片
                        </button>
                    </header>

                    <div className="flex flex-1 overflow-hidden">
                        {/* Controls Sidebar */}
                        <aside className="w-80 bg-white border-r border-gray-200 overflow-y-auto custom-scrollbar shadow-[4px_0_24px_rgba(0,0,0,0.02)] z-10">
                            <div className="p-6 space-y-8">
                                
                                {fontLoadError && (
                                    <div className="bg-amber-50 text-amber-700 px-4 py-3 rounded-lg flex items-start gap-2 text-sm">
                                        <AlertCircle size={16} className="mt-0.5 shrink-0" />
                                        <div>
                                            <p className="font-medium">字体加载失败</p>
                                            <p className="text-amber-600 text-xs mt-0.5">网络原因无法获取字体，已自动使用系统粗体。</p>
                                        </div>
                                    </div>
                                )}

                                {/* 1. Content Section (Only editable part) */}
                                <div className="space-y-4">
                                    <div className="flex items-center gap-2 text-gray-900 font-semibold border-b border-gray-100 pb-2">
                                        <Type size={18} className="text-blue-600" />
                                        <h2>文本内容</h2>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-600 mb-1.5">输入名字/文字</label>
                                        <input
                                            type="text"
                                            value={text}
                                            onChange={(e) => setText(e.target.value)}
                                            className="w-full px-4 py-3 bg-gray-50 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all text-xl font-medium text-center"
                                            placeholder="请输入"
                                            maxLength={4} 
                                        />
                                        <p className="text-xs text-gray-400 mt-2 text-center">建议输入 2-3 个汉字以达到最佳效果</p>
                                    </div>
                                </div>

                                {/* Fixed Settings Info */}
                                <div className="pt-6 border-t border-gray-100">
                                    <div className="flex items-center gap-2 text-gray-400 text-sm mb-3">
                                        <Lock size={14} />
                                        <span>统一规范参数 (已锁定)</span>
                                    </div>
                                    <div className="grid grid-cols-2 gap-3 text-xs text-gray-500">
                                        <div className="bg-gray-50 p-2 rounded border border-gray-100">
                                            <span className="block text-gray-400">字体</span>
                                            <span className="font-medium">优设标题黑</span>
                                        </div>
                                        <div className="bg-gray-50 p-2 rounded border border-gray-100">
                                            <span className="block text-gray-400">字号</span>
                                            <span className="font-medium">420px</span>
                                        </div>
                                        <div className="bg-gray-50 p-2 rounded border border-gray-100">
                                            <span className="block text-gray-400">描边</span>
                                            <span className="font-medium">#0172f1 (18px)</span>
                                        </div>
                                        <div className="bg-gray-50 p-2 rounded border border-gray-100">
                                            <span className="block text-gray-400">底图</span>
                                            <span className="font-medium">默认</span>
                                        </div>
                                    </div>
                                </div>
                                
                            </div>
                        </aside>

                        {/* Main Canvas Area */}
                        <main className="flex-1 bg-gray-200 relative flex items-center justify-center p-8 overflow-hidden">
                            <div className="absolute inset-0 opacity-20 pointer-events-none" style={{
                                backgroundImage: 'radial-gradient(#000 0.5px, transparent 0.5px)',
                                backgroundSize: '20px 20px'
                            }}></div>

                            <div className="relative shadow-2xl bg-white aspect-square h-full max-w-full overflow-hidden">
                                <canvas
                                    ref={canvasRef}
                                    width={CANVAS_SIZE}
                                    height={CANVAS_SIZE}
                                    className="w-full h-full object-contain"
                                />
                                
                                {/* 资源加载遮罩层 */}
                                {isLoading && (
                                    <div className="absolute inset-0 z-20 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center text-gray-600">
                                        <div className="relative">
                                            <div className="absolute inset-0 bg-blue-100 rounded-full animate-ping opacity-25"></div>
                                            <Loader2 size={48} className="animate-spin text-blue-600 mb-4 relative z-10" />
                                        </div>
                                        <p className="text-lg font-bold text-gray-800 tracking-tight">资源准备中</p>
                                        <div className="text-sm mt-2 space-y-1 text-center font-medium text-gray-500">
                                            {isFontLoading && <p className="animate-pulse">正在下载专用字体 (优设标题黑)...</p>}
                                            {isImageLoading && <p className="animate-pulse">正在加载高清底图...</p>}
                                        </div>
                                    </div>
                                )}
                            </div>
                        </main>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AvatarGenerator />);
    </script>
</body>
</html>

    
